<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Text Processor Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 220px; }
        pre { background: #111; color: #0f0; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
        .error { color: red; font-weight: bold; white-space: pre-wrap; }
        .row { margin-bottom: 14px; }
        .meta { font-family: monospace; }
    </style>
</head>
<body>
    <h2>Text AI Processor Debug</h2>

    <div class="row">
        <label for="sampleSelect">Load sample:</label>
        <select id="sampleSelect" onchange="loadSample()">
            <option value="">-- choose sample --</option>
            <option value="Rahim 01711234567 Mirpur 10 Black shirt 2pc">Sample 1 — Clean</option>
            <option value="017১১234567\nuttara ৭ no sector\nlal panjabi duita lagbe">Sample 2 — Banglish + Bengali digits</option>
            <option value="Rahim 01711234567 Mirpur 10 Black shirt 2pc\nKarim 01899888777 Uttara sector 7 Blue panjabi 1ta">Sample 3 — Two Orders</option>
            <option value="01711234567 dhanmondi road 5 red shirt">Sample 4 — Missing Quantity</option>
            <option value="bhai pls ekta lal shirt lagbe\namar nam Rahim\nphone 01711234567\naddress mirpur 10">Sample 5 — Extra Noise</option>
        </select>
    </div>

    <div class="row">
        <textarea id="inputText" placeholder="Paste messy order text here..."></textarea>
    </div>

    <button onclick="processText()">Process</button>

    <h3>Debug Metrics</h3>
    <div class="meta">Retry Count: <span id="retryCount">0</span></div>
    <div class="meta">Processing Time: <span id="processingTime">-</span></div>
    <div class="meta">Blocks Processed: <span id="blocksProcessed">0</span></div>

    <h3>1) Raw AI Extraction Output</h3>
    <pre id="rawOutput">{}</pre>

    <h3>2) After Auto-Fix</h3>
    <pre id="autoFixOutput">{}</pre>

    <h3>3) Final Validated Result</h3>
    <pre id="finalOutput">{}</pre>

    <h3>Validation Errors</h3>
    <div id="errorOutput" class="error"></div>

    <script>
        function loadSample() {
            const value = document.getElementById("sampleSelect").value;
            if (value) {
                document.getElementById("inputText").value = value;
            }
        }

        async function processText() {
            const text = document.getElementById("inputText").value;
            if (!text.trim()) {
                alert("Please paste some text first.");
                return;
            }

            try {
                const response = await fetch("http://localhost:8000/process-text", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                document.getElementById("retryCount").innerText = data.retry_count ?? 0;
                document.getElementById("processingTime").innerText = `${data.processing_time_seconds ?? 0}s`;
                document.getElementById("blocksProcessed").innerText = data.blocks_processed ?? 0;

                document.getElementById("rawOutput").innerText = JSON.stringify(
                    data.debug?.raw_ai_extraction_output ?? [],
                    null,
                    2
                );

                document.getElementById("autoFixOutput").innerText = JSON.stringify(
                    data.debug?.after_auto_fix ?? [],
                    null,
                    2
                );

                document.getElementById("finalOutput").innerText = JSON.stringify(
                    data.debug?.final_validated_result ?? data.results ?? {},
                    null,
                    2
                );

                let errors = "";
                (data.errors ?? []).forEach(err => {
                    errors += `${err}\n`;
                });

                document.getElementById("errorOutput").innerText = errors || "No validation errors.";
            } catch (error) {
                console.error("Error while processing text:", error);
                const message = error && error.message ? error.message : "An unknown error occurred.";
                document.getElementById("errorOutput").innerText =
                    "Failed to process text. " + message;
            }
        }
    </script>
</body>
</html>
